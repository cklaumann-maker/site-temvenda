<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funil de Vendas | TEM VENDA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#fff; --fg:#000; --muted:#666; --border:#E5E5E5; --light:#F8F9FA; --green:#5ee100; --danger:#ff4444; }
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--fg)}
        .container{max-width:1400px;margin:0 auto;padding:24px}
        .page-header{margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px}
        .page-title{font-size:24px;font-weight:800}
        .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:16px 0}
        .input,.select{border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:14px}
        .btn{border:1px solid var(--border);padding:10px 14px;border-radius:8px;background:#fff;font-weight:600;cursor:pointer}
        .btn:hover{border-color:#000}
        .btn-danger{color:var(--danger);border-color:rgba(255,68,68,.5)}
        .btn-danger:hover{border-color:var(--danger);background:rgba(255,68,68,.06)}
        .board{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-top:12px}
        .col{background:#fff;border:1px solid var(--border);border-radius:12px;min-height:300px;display:flex;flex-direction:column}
        .col-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .col-title{font-weight:800}
        .count{font-size:12px;color:var(--muted)}
        .col-body{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:240px;max-height:500px;overflow-y:auto}
        .card{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff;cursor:grab}
        .card:hover{border-color:#000}
        .card-header{display:flex;justify-content:space-between;gap:8px;align-items:center}
        .card-title{font-weight:700}
        .card-sub{color:var(--muted);font-size:12px}
        .card-details{display:none;margin-top:8px}
        .card.expanded .card-details{display:block}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(94,225,0,.12);color:var(--green);font-weight:700;font-size:11px}
        .muted{color:var(--muted);font-size:12px}
        .badge-red{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,68,68,.12);color:#ff4444;font-weight:800;font-size:11px;margin-left:6px}
        .chart{margin-top:20px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px}
        .bars{display:flex;gap:12px;align-items:flex-end;height:140px;margin-top:8px}
        .bar{flex:1;background:linear-gradient(180deg,var(--green),#baff7f);border-radius:6px 6px 0 0;min-height:4px}
        .bar-labels{display:flex;gap:12px;margin-top:6px}
        .bar-label{flex:1;text-align:center;font-size:12px;color:var(--muted)}
        @media(max-width:900px){.board{grid-template-columns:1fr}}
        /* Modal simples para hist√≥rico */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
        .modal{background:#fff;border:1px solid var(--border);border-radius:12px;max-width:840px;width:100%;max-height:80vh;display:flex;flex-direction:column}
        .modal-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-weight:800}
        .modal-body{padding:12px 16px;overflow:auto}
        .modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
        .history-item{border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px}
        .row{display:flex;gap:10px;flex-wrap:wrap}
        /* Bot√µes de √≠cone minimalistas */
        .btn-icon{width:28px;height:28px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;padding:0;font-size:14px;opacity:.65;border-color:#E9ECEF}
        .btn-icon:hover{opacity:.9}
        .btn-icon.whatsapp{color:#1ea955;border-color:#e9f7f0}
        .btn-icon.whatsapp:hover{border-color:#dff3ea;background:#f3fbf7}
        .btn-icon.history{color:#555;border-color:#eeeeee}
        .btn-icon.history:hover{border-color:#ddd;background:#f8f9fa}
        .btn-icon.danger{color:#d33;border-color:#f7e7e7}
        .btn-icon.danger:hover{border-color:#f0d0d0;background:#fcf3f3}
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header"><h1 class="page-title">Funil de Vendas</h1></div>

        <div class="toolbar">
            <input id="lead_name" class="input" placeholder="Nome">
            <input id="lead_email" class="input" placeholder="E-mail">
            <input id="lead_phone" class="input" placeholder="Telefone">
            <select id="lead_source" class="select">
                <option value="instagram">Instagram</option>
                <option value="linkedin">LinkedIn</option>
                <option value="facebook">Facebook</option>
                <option value="eventos">Eventos</option>
            </select>
            <button class="btn" onclick="addLead()">Adicionar lead</button>
            <select id="filter_source" class="select">
                <option value="">Todas as origens</option>
                <option value="diagnostico">Diagn√≥stico</option>
                <option value="instagram">Instagram</option>
                <option value="linkedin">LinkedIn</option>
                <option value="facebook">Facebook</option>
                <option value="eventos">Eventos</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="filter_late"> Somente atrasados (+7 dias)</label>
        </div>

        <div class="board" id="board">
            <div class="col" data-stage="entrada">
                <div class="col-header"><span class="col-title">ENTRADA</span><span class="count" id="count-entrada">0</span></div>
                <div class="col-body" id="col-entrada"></div>
            </div>
            <div class="col" data-stage="agenda">
                <div class="col-header"><span class="col-title">AGENDA INICIAL</span><span class="count" id="count-agenda">0</span></div>
                <div class="col-body" id="col-agenda"></div>
            </div>
            <div class="col" data-stage="followup">
                <div class="col-header"><span class="col-title">FOLLOW UP</span><span class="count" id="count-followup">0</span></div>
                <div class="col-body" id="col-followup"></div>
            </div>
            <div class="col" data-stage="interessado">
                <div class="col-header"><span class="col-title">INTERESSADO</span><span class="count" id="count-interessado">0</span></div>
                <div class="col-body" id="col-interessado"></div>
            </div>
            <div class="col" data-stage="fechado">
                <div class="col-header"><span class="col-title">FECHADO</span><span class="count" id="count-fechado">0</span></div>
                <div class="col-body" id="col-fechado"></div>
            </div>
        </div>

        <div class="chart">
            <div class="muted">Leads por etapa</div>
            <div class="bars">
                <div class="bar" id="bar-entrada" style="height:4px"></div>
                <div class="bar" id="bar-agenda" style="height:4px"></div>
                <div class="bar" id="bar-followup" style="height:4px"></div>
                <div class="bar" id="bar-interessado" style="height:4px"></div>
                <div class="bar" id="bar-fechado" style="height:4px"></div>
            </div>
            <div class="bar-labels">
                <div class="bar-label">Entrada</div>
                <div class="bar-label">Agenda</div>
                <div class="bar-label">Follow up</div>
                <div class="bar-label">Interessado</div>
                <div class="bar-label">Fechado</div>
            </div>
        </div>
    </div>

    <!-- Modal Hist√≥rico -->
    <div id="history_backdrop" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Hist√≥rico do Lead</div>
                <button class="btn" onclick="closeHistory()">Fechar</button>
            </div>
            <div class="modal-body">
                <div id="history_lead_info" class="muted" style="margin-bottom:8px"></div>
                <div id="history_list"></div>
                <div id="history_form_wrapper" style="margin-top:12px;display:none">
                    <div class="row" style="margin-bottom:8px">
                        <select id="activity_type" class="select" style="min-width:200px">
                            <option value="whatsapp">WhatsApp</option>
                            <option value="ligacao">Liga√ß√£o</option>
                            <option value="email">E-mail</option>
                            <option value="reuniao">Reuni√£o</option>
                            <option value="outro">Outro</option>
                        </select>
                        <input id="activity_next" class="input" type="date" placeholder="Pr√≥xima tarefa/data">
                    </div>
                    <textarea id="activity_notes" class="input" style="width:100%;min-height:90px" placeholder="Anota√ß√µes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn_add_activity" class="btn" style="display:none" onclick="addActivity()">Adicionar atividade</button>
            </div>
        </div>
    </div>

    <script src="/auth-manager.js"></script>
    <script>
        // Permiss√£o b√°sica
        document.addEventListener('DOMContentLoaded', () => {
            // Ver permiss√£o para ver o funil
            if (!window.authManager.requirePermission('ver_funil')) return;
            // Drag & drop somente para quem pode editar
            if (window.authManager.hasPermission('editar_funil')) enableDnD();
            else document.querySelectorAll('.col-body').forEach(b=> b.style.opacity = .95);
            document.getElementById('filter_source').addEventListener('change', loadLeads);
            document.getElementById('filter_late').addEventListener('change', loadLeads);
            loadLeads();
        });

        const SUPABASE_URL = 'https://mgcoyeohqelystqmytah.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nY295ZW9ocWVseXN0cW15dGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NzAzNjQsImV4cCI6MjA3NzI0NjM2NH0.KBKHH10DaV0m5SroFmXsTedS_dalcAprKnUOI4Unkx4';

        async function loadLeads(){
            const cols = { entrada: byId('col-entrada'), agenda: byId('col-agenda'), followup: byId('col-followup'), interessado: byId('col-interessado'), fechado: byId('col-fechado') };
            Object.values(cols).forEach(c=>c.innerHTML='');
            try{
                const params = new URLSearchParams({ select:'*', order:'created_at.asc' });
                const src = byId('filter_source').value;
                if (src) params.append('source', `eq.${src}`);
                const res = await fetch(`${SUPABASE_URL}/rest/v1/leads_funnel?${params.toString()}`, { headers:{ apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` } });
                let rows = res.ok ? await res.json() : [];
                if (byId('filter_late').checked) {
                    const seven = 7*24*60*60*1000, now = Date.now();
                    rows = rows.filter(r => !r.last_contact_at || (now - new Date(r.last_contact_at).getTime()) > seven);
                }
                rows.forEach(r=> renderCard(r));
                updateCounts();
            }catch(e){ console.warn(e); }
        }

        function byId(id){ return document.getElementById(id); }

        function renderCard(r){
            const map = { entrada:'col-entrada', agenda:'col-agenda', followup:'col-followup', interessado:'col-interessado', fechado:'col-fechado' };
            const colId = map[r.stage] || 'col-entrada';
            const diff = r.last_contact_at ? (Date.now()-new Date(r.last_contact_at).getTime()) : 0;
            const days = r.last_contact_at ? Math.floor(diff/86400000) : '‚Äî';
            const late = (typeof days === 'number' && days > 7);
            const el = document.createElement('div');
            el.className='card';
            el.draggable = r.stage!=='fechado' && window.authManager.hasPermission('editar_funil'); el.dataset.id = r.id;
            el.innerHTML = `
                <div class="card-header" onclick="toggleCard(this.parentElement)">
                    <div>
                        <div class="card-title">${escapeHtml(r.name||'-')}</div>
                        <div class="card-sub">${escapeHtml(r.phone||'-')}</div>
                    </div>
                    ${late?'<span class="badge-red">Atrasado</span>':''}
                </div>
                <div class="card-details">
                    <div class="muted">${escapeHtml(r.email||'-')}</div>
                    <div class="muted" style="margin-top:4px">Origem: <span class="pill">${escapeHtml(r.source||'-')}</span></div>
                    <div class="muted">Dias sem contato: <strong>${days}</strong></div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
                        ${r.stage==='fechado' ? '' : `<span class=\"muted\" style=\"font-size:12px\">Aquecimento:</span><input aria-label=\"Nota de aquecimento\" title=\"Nota do quanto o lead est√° aquecido (0-10)\" type=\"number\" min=\"0\" max=\"10\" value=\"${r.score??0}\" style=\"width:72px\" onchange=\"updateScore('${r.id}', this.value)\" />`}
                        <a class="btn btn-icon whatsapp" target="_blank" title="WhatsApp" aria-label="WhatsApp" href="${buildWhatsAppUrl(r.phone, r.name)}">üìû</a>
                        <button class="btn btn-icon history" title="Hist√≥rico" aria-label="Hist√≥rico" onclick="openHistory('${r.id}', '${escapeHtml(r.name||'')}', '${escapeHtml(r.email||'')}', '${escapeHtml(r.phone||'')}')">üìù</button>
                        <button class="btn btn-icon danger" title="Excluir" aria-label="Excluir" onclick="deleteLead('${r.id}')">üóëÔ∏è</button>
                        ${r.stage==='fechado' && window.authManager.hasPermission('editar_funil') ? `<button class=\"btn btn-icon\" title=\"Reabrir\" aria-label=\"Reabrir\" onclick=\"reopenLead('${r.id}')\">‚Ü©Ô∏è</button>`:''}
                    </div>
                </div>
            `;
            addDragHandlers(el);
            document.getElementById(colId).appendChild(el);
        }

        function updateCounts(){
            const ids = ['entrada','agenda','followup','interessado','fechado'];
            const counts = Object.fromEntries(ids.map(id=>[id, document.getElementById('col-'+id).children.length]));
            ids.forEach(id=> document.getElementById('count-'+id).textContent = counts[id]);
            const total = Math.max(1, ids.reduce((a,k)=>a+counts[k],0));
            document.getElementById('bar-entrada').style.height = (4 + 120*counts.entrada/total) + 'px';
            document.getElementById('bar-agenda').style.height = (4 + 120*counts.agenda/total) + 'px';
            document.getElementById('bar-followup').style.height = (4 + 120*counts.followup/total) + 'px';
            document.getElementById('bar-interessado').style.height = (4 + 120*counts.interessado/total) + 'px';
            document.getElementById('bar-fechado').style.height = (4 + 120*counts.fechado/total) + 'px';
        }

        async function addLead(){
            const name = document.getElementById('lead_name').value.trim();
            const email = document.getElementById('lead_email').value.trim();
            const phone = document.getElementById('lead_phone').value.trim();
            const source = document.getElementById('lead_source').value;
            if(!name){ alert('Informe o nome'); return; }
            if (!window.authManager.hasPermission('editar_funil')) { alert('Voc√™ n√£o tem permiss√£o para adicionar leads.'); return; }
            const payload = { name, email, phone, source, stage:'entrada', score:0, last_contact_at: new Date().toISOString() };
            try{
                const res = await fetch(`${SUPABASE_URL}/rest/v1/leads_funnel`, { method:'POST', headers:{ 'Content-Type':'application/json', apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, Prefer:'return=representation' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error(await res.text());
                const [row] = await res.json();
                renderCard(row); updateCounts();
                ['lead_name','lead_email','lead_phone'].forEach(id=>document.getElementById(id).value='');
            }catch(e){ alert('Erro ao criar lead: '+e.message); }
        }

        async function updateScore(id, score){
            try{
                await fetch(`${SUPABASE_URL}/rest/v1/leads_funnel?id=eq.${id}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` }, body: JSON.stringify({ score: Number(score), last_contact_at: new Date().toISOString() }) });
            }catch(e){ console.warn(e); }
        }

        async function deleteLead(id){
            if (!window.authManager.hasPermission('apagar_lead')) { alert('Sem permiss√£o para excluir.'); return; }
            if(!confirm('Excluir este lead do funil?')) return;
            try{
                await fetch(`${SUPABASE_URL}/rest/v1/leads_funnel?id=eq.${id}`, { method:'DELETE', headers:{ apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` } });
                document.querySelectorAll(`[data-id="${id}"]`).forEach(n=>n.remove());
                updateCounts();
            }catch(e){ alert('Erro ao excluir: '+e.message); }
        }

        function enableDnD(){
            document.querySelectorAll('.col-body').forEach(body=>{
                body.addEventListener('dragover', e=>{ e.preventDefault(); body.style.background='#f6fff2'; });
                body.addEventListener('dragleave', ()=> body.style.background='');
                body.addEventListener('drop', async e=>{
                    e.preventDefault(); body.style.background='';
                    const id = e.dataTransfer.getData('text/plain');
                    if(!id) return;
                    body.appendChild(document.querySelector(`[data-id="${id}"]`));
                    updateCounts();
                    const stage = body.id.replace('col-','');
                    try{ await fetch(`${SUPABASE_URL}/rest/v1/leads_funnel?id=eq.${id}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` }, body: JSON.stringify({ stage, last_contact_at: new Date().toISOString() }) }); }catch(e){ console.warn(e); }
                });
            });
        }

        function addDragHandlers(el){
            el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', el.dataset.id); });
        }

        function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

        function toggleCard(cardEl){
            if (!cardEl) return;
            cardEl.classList.toggle('expanded');
        }

        // -------------------- Hist√≥rico por Lead --------------------
        let currentHistoryLead = null;

        function buildWhatsAppUrl(phone, name){
            const digits = String(phone||'').replace(/\D/g,'');
            const intl = digits.length <= 11 ? ('55'+digits) : digits; // adiciona DDI BR se faltar
            const firstName = String(name||'').trim().split(/\s+/)[0] || '';
            const text = encodeURIComponent(`ol√° ${firstName} e aqui √© do TEM VENDA, `);
            return `https://wa.me/${intl}?text=${text}`;
        }

        async function openHistory(leadId, name, email, phone){
            if (!window.authManager.requirePermission('ver_historico')) return;
            currentHistoryLead = { id: leadId, name, email, phone };
            document.getElementById('history_lead_info').textContent = `${name} ¬∑ ${email} ¬∑ ${phone}`;
            const canEdit = window.authManager.hasPermission('editar_historico');
            document.getElementById('history_form_wrapper').style.display = canEdit ? 'block' : 'none';
            document.getElementById('btn_add_activity').style.display = canEdit ? 'inline-block' : 'none';
            document.getElementById('history_backdrop').style.display = 'flex';
            await loadActivities(leadId);
        }

        function closeHistory(){
            document.getElementById('history_backdrop').style.display = 'none';
            currentHistoryLead = null;
            document.getElementById('history_list').innerHTML = '';
        }

        async function loadActivities(leadId){
            const list = document.getElementById('history_list');
            list.innerHTML = '<div class="muted">Carregando...</div>';
            try{
                const params = new URLSearchParams({ select:'*', order:'created_at.desc', lead_id:`eq.${leadId}` });
                const res = await fetch(`${SUPABASE_URL}/rest/v1/lead_activities?${params.toString()}`, { headers:{ apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` } });
                const rows = res.ok ? await res.json() : [];
                if (!rows.length){ list.innerHTML = '<div class="muted">Sem atividades ainda.</div>'; return; }
                list.innerHTML = rows.map(a=> `
                    <div class="history-item">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                            <div style="font-weight:700;text-transform:capitalize">${escapeHtml(a.contact_type||'‚Äî')}</div>
                            <div class="muted">${new Date(a.created_at).toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="muted" style="white-space:pre-wrap">${escapeHtml(a.notes||'')}</div>
                        ${a.next_task_at ? `<div class="muted" style="margin-top:6px">Pr√≥xima tarefa: <strong>${new Date(a.next_task_at).toLocaleDateString('pt-BR')}</strong></div>`:''}
                    </div>
                `).join('');
            }catch(e){
                list.innerHTML = '<div class="muted">Erro ao carregar hist√≥rico.</div>';
            }
        }

        async function addActivity(){
            if (!currentHistoryLead) return;
            if (!window.authManager.hasPermission('editar_historico')) { alert('Sem permiss√£o para editar hist√≥rico.'); return; }
            const contact_type = document.getElementById('activity_type').value;
            const notes = document.getElementById('activity_notes').value.trim();
            const next_task_at_raw = document.getElementById('activity_next').value;
            const payload = { lead_id: currentHistoryLead.id, contact_type, notes: notes || null, next_task_at: next_task_at_raw ? new Date(next_task_at_raw).toISOString() : null };
            try{
                const res = await fetch(`${SUPABASE_URL}/rest/v1/lead_activities`, { method:'POST', headers:{ 'Content-Type':'application/json', apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}`, Prefer:'return=representation' }, body: JSON.stringify(payload) });
                if(!res.ok) throw new Error(await res.text());
                try{ await fetch(`${SUPABASE_URL}/rest/v1/leads_funnel?id=eq.${currentHistoryLead.id}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', apikey:SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` }, body: JSON.stringify({ last_contact_at: new Date().toISOString() }) }); }catch(_e){}
                document.getElementById('activity_notes').value = '';
                document.getElementById('activity_next').value = '';
                await loadActivities(currentHistoryLead.id);
                await loadLeads();
            }catch(e){ alert('Erro ao salvar atividade: '+e.message); }
        }
    </script>
</body>
</html>


