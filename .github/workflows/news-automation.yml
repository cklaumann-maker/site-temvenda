name: Coleta de Not√≠cias Autom√°tica

on:
  schedule:
    # Quartas e s√°bados √†s 8h (hor√°rio de Bras√≠lia)
    # UTC-3 = UTC+11 (11h UTC = 8h Bras√≠lia)
    - cron: '0 11 * * 3,6'
  workflow_dispatch: # Permite execu√ß√£o manual via interface do GitHub

jobs:
  collect-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v3
      
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: üì¶ Instalar depend√™ncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # For√ßar vers√£o compat√≠vel do httpx para evitar erro de proxy
        pip install --force-reinstall httpx==0.24.0
        
    - name: üîê Configurar Google Service Account
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        mkdir -p automation/config
        if [ -n "$GOOGLE_CREDENTIALS" ]; then
          echo "$GOOGLE_CREDENTIALS" > automation/config/service_account.json
          echo "‚úÖ Service account configurado em automation/config/"
        else
          echo "‚ö†Ô∏è GOOGLE_CREDENTIALS n√£o configurado (ignorando coleta de PDFs do Drive)"
        fi
        
    - name: üì∞ Executar coleta de not√≠cias RSS
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "üöÄ Iniciando coleta de not√≠cias..."
        echo "üìÅ Diret√≥rio atual: $(pwd)"
        echo "üìÅ Listando automation/scripts:"
        ls -la automation/scripts/ || echo "‚ö†Ô∏è Pasta n√£o encontrada"
        echo ""
        echo "üîç Verificando secrets..."
        if [ -z "$SUPABASE_URL" ]; then
          echo "‚ùå ERRO: SUPABASE_URL n√£o configurado!"
          exit 1
        fi
        if [ -z "$SUPABASE_KEY" ]; then
          echo "‚ùå ERRO: SUPABASE_KEY n√£o configurado!"
          exit 1
        fi
        if [ -z "$OPENAI_API_KEY" ]; then
          echo "‚ùå ERRO: OPENAI_API_KEY n√£o configurado!"
          exit 1
        fi
        echo "‚úÖ Todos os secrets est√£o configurados"
        echo ""
        cd automation/scripts
        echo "üìÅ Agora em: $(pwd)"
        echo "üìÑ Arquivos Python encontrados:"
        ls -la *.py || echo "‚ö†Ô∏è Nenhum arquivo .py encontrado"
        echo ""
        echo "üöÄ Executando news_collector.py..."
        python3 news_collector.py || {
          echo "‚ùå Erro ao executar news_collector.py"
          exit 1
        }
        echo "‚úÖ Coleta de not√≠cias conclu√≠da"
        
    - name: üìÑ Executar coleta de PDFs do Google Drive
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_SERVICE_ACCOUNT_PATH: automation/config/service_account.json
      continue-on-error: true # Continua mesmo se falhar (pode n√£o ter Google configurado)
      run: |
        if [ -f "automation/config/service_account.json" ] || [ -n "${{ secrets.GOOGLE_CREDENTIALS }}" ]; then
          echo "üöÄ Iniciando coleta de PDFs do Drive..."
          cd automation/scripts
          python3 drive_pdf_collector.py
          echo "‚úÖ Coleta de PDFs conclu√≠da"
        else
          echo "‚è≠Ô∏è Pulando coleta de PDFs (service account n√£o configurado)"
        fi
        
    - name: üìä Verificar resultados
      run: |
        echo "‚úÖ Workflow executado com sucesso!"
        echo "üìÖ Pr√≥xima execu√ß√£o: Quartas e s√°bados √†s 8h (hor√°rio de Bras√≠lia)"
